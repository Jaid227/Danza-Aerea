
<!DOCTYPE html>
<html>
<head>
    <title>Comentarios con Respuestas</title>
    <link rel="stylesheet" href="estilos.css">
</head>

<body>

<h1>Comentarios</h1>

<div class="formulario">
    <input id="nombre" placeholder="Tu nombre">
    <textarea id="mensaje" placeholder="Escribe tu comentario"></textarea>

    <button onclick="guardarComentario()">
        Enviar comentario
    </button>
</div>

<h2>Todos los comentarios:</h2>

<div id="lista"></div>


<!-- ========== FIREBASE ========== -->
<script type="module">

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot,
  orderBy,
  query,
  doc
} from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


// ⚠️ AQUÍ PONES TUS DATOS DE FIREBASE
const firebaseConfig = {
  apiKey: "TU_API",
  authDomain: "TU_DOMINIO",
  projectId: "TU_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ===== GUARDAR COMENTARIO PRINCIPAL =====
window.guardarComentario = async function() {

  let nombre = nombre.value = document.getElementById("nombre").value;
  let mensaje = document.getElementById("mensaje").value;

  if(nombre == "" || mensaje == ""){
    alert("Llena todo");
    return;
  }

  await addDoc(collection(db, "comentarios"), {
    nombre: nombre,
    mensaje: mensaje,
    fecha: new Date()
  });

  document.getElementById("mensaje").value = "";
}



// ===== MOSTRAR COMENTARIOS =====
const q = query(
  collection(db, "comentarios"),
  orderBy("fecha", "desc")
);

onSnapshot(q, (datos) => {

  let html = "";

  datos.forEach(com => {

    let c = com.data();

    html += `
      <div class="comentario">

        <b>${c.nombre}</b>
        <p>${c.mensaje}</p>

        <button onclick="mostrarCaja('${com.id}')">
            Responder
        </button>

        <div id="caja-${com.id}" class="caja-respuesta oculto">

          <input id="nom-${com.id}" placeholder="Tu nombre">
          <textarea id="msj-${com.id}" 
            placeholder="Tu respuesta"></textarea>

          <button onclick="guardarRespuesta('${com.id}')">
            Enviar respuesta
          </button>

        </div>

        <div id="respuestas-${com.id}" 
             class="zona-respuestas">
        </div>

      </div>
    `;

    cargarRespuestas(com.id);

  });

  document.getElementById("lista").innerHTML = html;

});



// ===== MOSTRAR CAJA RESPUESTA =====
window.mostrarCaja = function(id){
  document.getElementById("caja-" + id)
          .classList.toggle("oculto");
}



// ===== GUARDAR RESPUESTA =====
window.guardarRespuesta = async function(id){

  let nombre =
   document.getElementById("nom-" + id).value;

  let mensaje =
   document.getElementById("msj-" + id).value;

  if(nombre == "" || mensaje == ""){
    alert("Llena todo");
    return;
  }

  await addDoc(
    collection(db, "comentarios", id, "respuestas"),
    {
      nombre: nombre,
      mensaje: mensaje,
      fecha: new Date()
    }
  );

  document.getElementById("msj-" + id).value = "";

}



// ===== CARGAR RESPUESTAS =====
function cargarRespuestas(id){

  const qr = query(
    collection(db, "comentarios", id, "respuestas"),
    orderBy("fecha", "asc")
  );

  onSnapshot(qr, (datos) => {

    let html = "";

    datos.forEach(r => {

      let d = r.data();

      html += `
        <div class="respuesta">
          <b>${d.nombre}</b>
          <p>${d.mensaje}</p>
        </div>
      `;
    });

    let zona =
     document.getElementById("respuestas-" + id);

    if(zona){
      zona.innerHTML = html;
    }

  });

}

</script>

</body>
</html>





